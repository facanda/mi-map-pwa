<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ruta Pro Multi</title>

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#0b1220">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:Arial;background:#0b1220;color:#fff}
#map{position:absolute;inset:0}
.panel{
position:absolute;bottom:12px;left:12px;right:12px;
background:rgba(17,24,39,.95);
padding:14px;border-radius:16px;
box-shadow:0 10px 30px rgba(0,0,0,.4);
}
.big{font-size:20px;font-weight:bold}
.small{font-size:13px;color:#ccc}
button{
padding:8px 12px;border-radius:10px;border:none;
background:#2563eb;color:white;cursor:pointer;margin-right:6px
}
button.secondary{background:#374151}
</style>
</head>
<body>

<div id="map"></div>

<div class="panel">
<div class="big" id="metricDistance">â€”</div>
<div class="small" id="metricDuration">Tiempo: â€”</div>
<div class="small" id="singleCity">Ciudad: â€”</div>
<div style="margin-top:10px">
<button id="modeSolo">ðŸ“Œ Solo punto</button>
<button id="modeRoute" class="secondary">ðŸ§­ Ruta</button>
<button id="resetBtn" class="secondary">âŸ² Reset</button>
</div>
</div>

<script>
const map = L.map('map').setView([39.8283,-98.5795],4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let soloMode = true;
let soloMarker = null;
let userLatLng = null;
let routeLayer = null;
let routePoints = [];

// ---------------- HELPERS ----------------

function milesFromMeters(m){ return m/1609.344; }

function formatTimeSeconds(sec){
const totalMin=Math.round(sec/60);
const h=Math.floor(totalMin/60);
const m=totalMin%60;
return h?`${h} h ${m} min`:`${m} min`;
}

function bearingDegrees(from,to){
const lat1=from.lat*Math.PI/180;
const lat2=to.lat*Math.PI/180;
const dLon=(to.lng-from.lng)*Math.PI/180;
const y=Math.sin(dLon)*Math.cos(lat2);
const x=Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);
let brng=Math.atan2(y,x)*180/Math.PI;
return(brng+360)%360;
}

function degToCompass8(deg){
const dirs=["N","NE","E","SE","S","SW","W","NW"];
return dirs[Math.round(deg/45)%8];
}

// ---------------- NOMINATIM ----------------

async function nominatimReverse(lat,lon){
const url=`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
const res=await fetch(url);
const data=await res.json();
const a=data.address||{};

// SIN COUNTY
const city=a.city||a.town||a.village||a.municipality||"";
const locality=a.locality||a.city_district||a.suburb||a.neighbourhood||a.hamlet||"";
const finalCity=city||locality||"Ciudad no encontrada";

// ESTADO robusto
const state=
a.state||
a.region||
a.state_district||
a.province||
a.territory||
"";

return{
city:finalCity,
state,
country:a.country||"",
display:data.display_name||finalCity
};
}

// centro ciudad
const cacheCenter=new Map();

async function getPlaceCenter(city,state,country){
const key=`${city}|${state}|${country}`;
if(cacheCenter.has(key))return cacheCenter.get(key);

const q=[city,state,country].filter(Boolean).join(",");
const url=`https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}&limit=1`;
const res=await fetch(url);
const arr=await res.json();
if(!arr.length)return null;

const center=L.latLng(arr[0].lat,arr[0].lon);
cacheCenter.set(key,center);
return center;
}

async function prettyRelativeCity(latlng){
const r=await nominatimReverse(latlng.lat,latlng.lng);
const cityWithState=r.state?`${r.city}, ${r.state}`:r.city;

const center=await getPlaceCenter(r.city,r.state,r.country);
if(!center)return cityWithState;

const mi=milesFromMeters(map.distance(center,latlng));
const dir=degToCompass8(bearingDegrees(center,latlng));

if(mi<0.15)return cityWithState;

return `${mi.toFixed(2)} mi ${dir} ${cityWithState}`;
}

// ---------------- SOLO PUNTO ----------------

async function handleSoloPoint(latlng){
if(soloMarker)map.removeLayer(soloMarker);
soloMarker=L.marker(latlng).addTo(map);

const text=await prettyRelativeCity(latlng);
document.getElementById("singleCity").innerText=`Ciudad: ${text}`;

try{
if(!userLatLng){
userLatLng=await new Promise((resolve,reject)=>{
navigator.geolocation.getCurrentPosition(
pos=>resolve(L.latLng(pos.coords.latitude,pos.coords.longitude)),
reject);
});
}
const miles=milesFromMeters(map.distance(userLatLng,latlng));
document.getElementById("metricDistance").innerText=`${miles.toFixed(2)} mi`;
document.getElementById("metricDuration").innerText="Desde tu ubicaciÃ³n";
}catch{
document.getElementById("metricDistance").innerText="â€”";
}
}

// ---------------- RUTA ----------------

async function computeRoute(){
if(routePoints.length<2)return;

const coords=routePoints.map(p=>`${p.lng},${p.lat}`).join(";");
const url=`https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`;

const res=await fetch(url);
const data=await res.json();
const route=data.routes[0];

if(routeLayer)map.removeLayer(routeLayer);
routeLayer=L.geoJSON(route.geometry,{style:{weight:6}}).addTo(map);
map.fitBounds(routeLayer.getBounds());

const miles=milesFromMeters(route.distance);
document.getElementById("metricDistance").innerText=`${miles.toFixed(2)} mi`;
document.getElementById("metricDuration").innerText=`Tiempo: ${formatTimeSeconds(route.duration)}`;
document.getElementById("singleCity").innerText="Ciudad: â€”";
}

// ---------------- MAP CLICK ----------------

map.on("click",async e=>{
if(soloMode){
await handleSoloPoint(e.latlng);
}else{
routePoints.push(e.latlng);
L.marker(e.latlng).addTo(map);
}
});

// ---------------- BUTTONS ----------------

document.getElementById("modeSolo").onclick=()=>{
soloMode=true;
routePoints=[];
};

document.getElementById("modeRoute").onclick=()=>{
soloMode=false;
routePoints=[];
};

document.getElementById("resetBtn").onclick=()=>{
location.reload();
};

</script>
</body>
</html>
